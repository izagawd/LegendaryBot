@page "/teams"
@using Microsoft.AspNetCore.Authorization
@using Website.Components.Navigation
@using Website.Services
@using Website.Components
@inject HttpClient Http
@inject WebsiteThemeService WebTheme
@attribute [Authorize]
@code {


    private static readonly TimeSpan BadRequestTimeSpan = TimeSpan.FromSeconds(2);
    enum SortType
    {
        Level,
        Rarity,
        Name
    }

    private SortType CurrentSortType = SortType.Level;

    bool reverseOrder = false;
    protected TeamCharactersDto? TeamCharacterDto { get; set; }


    protected TeamDto? CurrentTeam;


    private string? ErrorText;
    private string _currentFilter = "";

    protected override async Task OnInitializedAsync()
    {
        var gotten = await Http.GetAsync("TeamPage/get-teams-and-characters");
        if (gotten.IsSuccessStatusCode)
        {
            TeamCharacterDto = await gotten.Content.ReadFromJsonAsync<TeamCharactersDto>();
            CurrentTeam = TeamCharacterDto!.EquippedTeam;
        }
        else
        {
            ErrorText = await gotten.Content.ReadAsStringAsync();
        }

 
    }

    Task OnChangeTeamAsync(ChangeEventArgs eventArgs)
    {
        var asString = (string)eventArgs.Value!;
        var asLong = long.Parse(asString);
        CurrentTeam = TeamCharacterDto!.Teams.FirstOrDefault(i => i.Id == asLong);
        return Task.CompletedTask;
    }

    public CharacterDto? CurrentDraggedCharacter = null;
    public async Task RemoveFromTeamAsync(int slot)
    {
        var responseMessage = await Http.PostAsync("TeamPage/remove-from-team", new FormUrlEncodedContent([
            new KeyValuePair<string, string>("slot", slot.ToString()),
            new KeyValuePair<string, string>("teamId", CurrentTeam!.Id.ToString())
        ]));
        if (responseMessage.IsSuccessStatusCode)
        {
            CurrentTeam.CharacterSlots.RemoveAll(i => i.Slot == slot);
        }
        else
        {
            await SnackBar!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                await responseMessage.Content.ReadAsStringAsync(),
                BadRequestTimeSpan
            ){SnackBarLayout = SnackBar.SnackBarLayout.Error});
        }
    }

    async Task OnDropOnSlot(int slot)
    {
        if (CurrentDraggedCharacter is not null)
        {
            var currentCharIsInCurrTeam = CurrentTeam!.GetCharacters(TeamCharacterDto!).Contains(CurrentDraggedCharacter);
            if (currentCharIsInCurrTeam
             && CurrentTeam.CharacterSlots.Any(i => i.Slot == slot))
            {
                var currentCharSlot = CurrentTeam.CharacterSlots.First(i => i.CharacterId == CurrentDraggedCharacter.Id);

                var result = await Http.PostAsync("TeamPage/switch-slots",
                    new FormUrlEncodedContent([
                        new KeyValuePair<string, string>("slot1", currentCharSlot.Slot.ToString()),
                        new KeyValuePair<string, string>("teamId", CurrentTeam!.Id.ToString()),
                        new KeyValuePair<string, string>("slot2", slot.ToString())
                    ]));
                if (result.IsSuccessStatusCode)
                {
                    var otherSlot = CurrentTeam.CharacterSlots.First(i => i.Slot == slot);
                    (otherSlot.Slot, currentCharSlot.Slot) = (currentCharSlot.Slot, otherSlot.Slot);
                }
                else
                {
                    Console.WriteLine("bruh");
                    await SnackBar!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                        await result.Content.ReadAsStringAsync(),
                        BadRequestTimeSpan
                    ){SnackBarLayout = SnackBar.SnackBarLayout.Error});
                }
            }
            else
            {
            
                var result = await Http.PostAsync("TeamPage/set-slot",
                    new FormUrlEncodedContent([
                        new KeyValuePair<string, string>("slot", slot.ToString()),
                        new KeyValuePair<string, string>("teamId", CurrentTeam!.Id.ToString()),
                        new KeyValuePair<string, string>("characterId", CurrentDraggedCharacter.Id.ToString())
                    ]));
                if (result.IsSuccessStatusCode)
                {
                    if (currentCharIsInCurrTeam)
                    {
                        CurrentTeam.CharacterSlots.RemoveAll(i => i.CharacterId == CurrentDraggedCharacter.Id);
                    }
                    var gotten = CurrentTeam.CharacterSlots.FirstOrDefault(i => i.Slot == slot);
                    if (gotten is null)
                    {
                        CurrentTeam.CharacterSlots.Add(new CharacterSlot()
                        {
                            CharacterId = CurrentDraggedCharacter.Id,
                            Slot = slot
                        });
                    }
                    else
                    {
                        gotten.CharacterId = CurrentDraggedCharacter.Id;
                    }
                }
                else
                {
                    await SnackBar!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                        await result.Content.ReadAsStringAsync(),
                        BadRequestTimeSpan
                    ){SnackBarLayout = SnackBar.SnackBarLayout.Error});
                }
                

            }

        }

    }

    async Task RenameTeamAsync(ChangeEventArgs args)
    {
        var newName = (string)args.Value!;

        var didChange  = await Http.PostAsync("TeamPage/rename-team",
            new FormUrlEncodedContent([
                new KeyValuePair<string, string>("teamId", CurrentTeam!.Id.ToString()),
                new KeyValuePair<string, string>("newName", newName)
            ]));
        if (didChange.IsSuccessStatusCode)
        {
            CurrentTeam.Name = newName;
            StateHasChanged();
            await SnackBar!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                $"Team name changed to {newName}!",
                BadRequestTimeSpan
            ){SnackBarLayout = SnackBar.SnackBarLayout.Success});
        }
        else
        {
            
            await SnackBar!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                await didChange.Content.ReadAsStringAsync(),
                BadRequestTimeSpan
            ){SnackBarLayout = SnackBar.SnackBarLayout.Error});
            
        }
    }
    async Task EquipTeamAsync()
    {
        
        var res = await Http.PostAsync("TeamPage/equip-team",
            new FormUrlEncodedContent([
                new KeyValuePair<string, string>
                    ("teamId", CurrentTeam!.Id.ToString())
            ]));
        if (res.IsSuccessStatusCode)
        {
            TeamCharacterDto!.EquippedTeamId = CurrentTeam.Id;
            StateHasChanged();
            await SnackBar!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                $"Team {CurrentTeam.Name} is now equipped!",
                BadRequestTimeSpan
            ){SnackBarLayout = SnackBar.SnackBarLayout.Success});
        }       else
        {
            await SnackBar!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                await res.Content.ReadAsStringAsync(),
                BadRequestTimeSpan
            ){SnackBarLayout = SnackBar.SnackBarLayout.Error});
        }
      
    }



    SnackBar? SnackBar;


}
<Navigation>
    @if (TeamCharacterDto is not null && CurrentTeam is not null)
    {

        <div class="za-parent">
            <div class="team-settler">
                <div class="inputs">
                    <select @onchange="OnChangeTeamAsync">
                        @foreach (var i in TeamCharacterDto.Teams)
                        {
                            <option selected="@(i == CurrentTeam)" value="@i.Id">@i.Name</option>
                        }
                    </select>
                    <input type="text" placeholder="rename" @onchange="RenameTeamAsync"/>
                    @{
                        var currentIsEquipped = CurrentTeam == TeamCharacterDto.EquippedTeam;
                    }
                    <button style="@(currentIsEquipped ? "background-color: grey" : "")"
                            @onclick="EquipTeamAsync" class="equip-button">@(currentIsEquipped ? "Equipped" : "Equip")</button>
                </div>

                @{
                    string borderCol = WebTheme.WebsiteTheme == WebsiteTheme.Dark ? "white" : "black";
                }
                <div class="team-characters-container">
                    @for (var i = 1; i <= 4; i++)
                    {
                        var character = CurrentTeam.GetCharacter(i, TeamCharacterDto);

                        var i1 = i;
                        <div class="team-character-div" @ondragstart="() => CurrentDraggedCharacter = character" draggable="@(character is not null ? "true" : "false")"
                             ondragover="event.preventDefault()" @ondrop="() => OnDropOnSlot(i1)" style="border-color: @borderCol; background-color: @(WebTheme.WebsiteTheme == WebsiteTheme.Dark ? "gray" : "lightgrey")">
                            <a href="/inventory/characters/@(character?.Number ?? 0)">
                                <img style="border-color: @borderCol" src="@character?.ImageUrl" alt=""/>
                            </a>
                            <div class="paragraphs">
                                <p>@(character?.Name ?? "EMPTY SLOT")</p>
                                @if (character is not null)
                                {
                                    <p class="minor-info">Num @character.Number</p>
                                    <p class="minor-info">Lvl @character.Level</p>
                                }
                            </div>

                            @if (character is not null && CurrentTeam.GetCharacters(TeamCharacterDto).Count() > 1)
                            {
                                <div class="delete-bin-div" @onclick="() => RemoveFromTeamAsync(i1)">
                                    <span class="material-symbols-outlined">
                                        delete
                                    </span>
                                </div>
                            }



                        </div>
                    }
                </div>

            </div>
            @{
                var borCol = WebTheme.WebsiteTheme == WebsiteTheme.Dark ? "gray" : "black";
            }
            <div class="others-parent" style="border-color: @borCol">
                <div class="others">



                    <div class="filters">
                        <div class="filter-class">
                            <span class="material-symbols-outlined">
                                search
                            </span>
                            <input @onchange="args => _currentFilter = (string)args.Value!" style="border-color: @(WebTheme.WebsiteTheme == WebsiteTheme.Dark ? "white" : "black")" type="text" placeholder="Search"/>

                        </div>
                        <select @bind="CurrentSortType" style="width: 75px; height: 30px">
                            @foreach (var i in Enum.GetValues<SortType>())
                            {
                                <option value="@i">@i</option>
                            }
                        </select>
                        <input @bind="reverseOrder" type="checkbox"/>
                    </div>


                    @code{

                        Task RemoveDraggedCharacterFromTeamAsync()
                        {
                            if (CurrentDraggedCharacter is null) return Task.CompletedTask;
                            var currentSlot = CurrentTeam!.CharacterSlots.FirstOrDefault(i => i.CharacterId == CurrentDraggedCharacter.Id);
                            if (currentSlot is not null)
                            {
                                return RemoveFromTeamAsync(currentSlot.Slot);
                            }

                            return Task.CompletedTask;
                        }

                    }

                    <div class="other-characters-parent" style="border-color: @borCol">
                        <div class="other-characters" ondragover="event.preventDefault()" @ondrop="RemoveDraggedCharacterFromTeamAsync">

                            @code{

                                public IEnumerable<CharacterDto> NonTeamedCharacters
                                {
                                    get
                                    {
                                        var smallifiedFilter = _currentFilter.ToLower();
                                        var gotten = TeamCharacterDto.Characters.Where(i =>
                                            !CurrentTeam.GetCharacters(TeamCharacterDto).Contains(i) && i.Name!.ToLower().Contains(smallifiedFilter));
                                        switch (CurrentSortType)
                                        {
                                            case SortType.Level:
                                                gotten = gotten.OrderByDescending(i => i.Level);
                                                break;
                                            case SortType.Rarity:
                                                gotten = gotten.OrderByDescending(i => i.RarityNum);
                                                break;
                                            case SortType.Name:
                                                gotten = gotten.OrderBy(i => i.Name);
                                                break;

                                        }

                                        if (reverseOrder)
                                            gotten = gotten.Reverse();
                                        return gotten;
                                    }
                                }

                            }

                            @{

                                foreach (var i in NonTeamedCharacters)

                                {
                                    <div class="character-div" draggable="true" @ondragstart='() => CurrentDraggedCharacter = i'>
                                        <a href="/inventory/characters/@i.Number">
                                            <img src="@i.ImageUrl" style="border-color: @(WebTheme.WebsiteTheme == WebsiteTheme.Dark ? "white" : "black")" alt=""/>
                                        </a>
                                        <p>@i.Name</p>
                                        <p>Num @i.Number</p>
                                        <p>Lvl @i.Level</p>
                                    </div>

                                }
                            }

                        </div>
                    </div>

                </div>
            </div>


        </div>
        <SnackBar @ref="SnackBar"></SnackBar>
    }
    else
    {
        <div class="loading-or-failure-div">
            <div>
                @if (ErrorText is null)
                {
                    <h1>Loading...</h1>
                }
                else
                {
                    <h1>@ErrorText</h1>
                }
            </div>
        </div>

    }
</Navigation>