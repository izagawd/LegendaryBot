@page "/teams"
@using Microsoft.AspNetCore.Authorization
@using Website.Components
@using Website.Components.Navigation
@using Website.Services
@inject HttpClient Http
@inject SnackBarService SnackBarService
@attribute [Authorize]

@code {


    public string TheBorderToUse => WebsiteTheme == WebsiteTheme.Dark ? "lime" : "darkorange";
    private static readonly TimeSpan BadRequestTimeSpan = TimeSpan.FromSeconds(2);

    enum SortType
    {
        Level,
        Rarity,
        Name
    }

    [CascadingParameter] public WebsiteTheme WebsiteTheme { get; set; }
    private SortType CurrentSortType = SortType.Level;

    bool reverseOrder;
    protected TeamCharactersDto? TeamCharacterDto { get; set; }


    protected TeamDto? CurrentTeam;


    private string? ErrorText;
    private string _currentFilter = "";

    protected override async Task OnInitializedAsync()
    {
        var gotten = await Http.GetAsync("TeamPage/get-teams-and-characters");
        if (gotten.IsSuccessStatusCode)
        {
            TeamCharacterDto = await gotten.Content.ReadFromJsonAsync<TeamCharactersDto>();
            CurrentTeam = TeamCharacterDto!.EquippedTeam;

        }
        else
        {
            ErrorText = await gotten.Content.ReadAsStringAsync();
        }
    }

    Task OnChangeTeamAsync(ChangeEventArgs eventArgs)
    {
        var asString = (string)eventArgs.Value!;
        var asLong = long.Parse(asString);
        CurrentTeam = TeamCharacterDto!.Teams.FirstOrDefault(i => i.Id == asLong);
        PendingCharacter = null;
        return Task.CompletedTask;
    }



    public async Task RemoveFromTeamAsync(int slot)
    {
        var responseMessage = await Http.PostAsync("TeamPage/remove-from-team", new FormUrlEncodedContent([
            new KeyValuePair<string, string>("slot", slot.ToString()),
            new KeyValuePair<string, string>("teamId", CurrentTeam!.Id.ToString())
        ]));
        if (responseMessage.IsSuccessStatusCode)
        {
            CurrentTeam.CharacterSlots.RemoveAll(i => i.Slot == slot);
        }
        else
        {
            await SnackBarService!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                await responseMessage.Content.ReadAsStringAsync(),
                BadRequestTimeSpan
            ) { SnackBarLayout = SnackBar.SnackBarLayout.Error });
        }
    }

    async Task PutCharacterInSlot(int slot, CharacterDto characterToPutInSlot)
    {
        if (characterToPutInSlot is not null)
        {
            var currentCharIsInCurrTeam = CurrentTeam!.GetCharacters(TeamCharacterDto!).Contains(characterToPutInSlot);
            if (currentCharIsInCurrTeam
                && CurrentTeam.CharacterSlots.Any(i => i.Slot == slot))
            {
                var currentCharSlot = CurrentTeam.CharacterSlots.First(i => i.CharacterId == characterToPutInSlot.Id);

                var result = await Http.PostAsync("TeamPage/switch-slots",
                    new FormUrlEncodedContent([
                        new KeyValuePair<string, string>("slot1", currentCharSlot.Slot.ToString()),
                        new KeyValuePair<string, string>("teamId", CurrentTeam!.Id.ToString()),
                        new KeyValuePair<string, string>("slot2", slot.ToString())
                    ]));
                if (result.IsSuccessStatusCode)
                {
                    var otherSlot = CurrentTeam.CharacterSlots.First(i => i.Slot == slot);
                    (otherSlot.Slot, currentCharSlot.Slot) = (currentCharSlot.Slot, otherSlot.Slot);
                }
                else
                {
                    await SnackBarService!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                        await result.Content.ReadAsStringAsync(),
                        BadRequestTimeSpan
                    ) { SnackBarLayout = SnackBar.SnackBarLayout.Error });
                }
            }
            else
            {
                var result = await Http.PostAsync("TeamPage/set-slot",
                    new FormUrlEncodedContent([
                        new KeyValuePair<string, string>("slot", slot.ToString()),
                        new KeyValuePair<string, string>("teamId", CurrentTeam!.Id.ToString()),
                        new KeyValuePair<string, string>("characterId", characterToPutInSlot.Id.ToString())
                    ]));
                if (result.IsSuccessStatusCode)
                {
                    if (currentCharIsInCurrTeam)
                    {
                        CurrentTeam.CharacterSlots.RemoveAll(i => i.CharacterId == characterToPutInSlot.Id);
                    }

                    var gotten = CurrentTeam.CharacterSlots.FirstOrDefault(i => i.Slot == slot);
                    if (gotten is null)
                    {
                        CurrentTeam.CharacterSlots.Add(new CharacterSlot
                        {
                            CharacterId = characterToPutInSlot.Id,
                            Slot = slot
                        });
                    }
                    else
                    {
                        gotten.CharacterId = characterToPutInSlot.Id;
                    }
                }
                else
                {
                    await SnackBarService!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                        await result.Content.ReadAsStringAsync(),
                        BadRequestTimeSpan
                    ) { SnackBarLayout = SnackBar.SnackBarLayout.Error });
                }
            }
        }
    }

    async Task RenameTeamAsync(ChangeEventArgs args)
    {
        var newName = (string)args.Value!;

        var didChange = await Http.PostAsync("TeamPage/rename-team",
            new FormUrlEncodedContent([
                new KeyValuePair<string, string>("teamId", CurrentTeam!.Id.ToString()),
                new KeyValuePair<string, string>("newName", newName)
            ]));
        if (didChange.IsSuccessStatusCode)
        {
            CurrentTeam.Name = newName;
            StateHasChanged();
            await SnackBarService!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                $"Team name changed to {newName}!",
                BadRequestTimeSpan
            ) { SnackBarLayout = SnackBar.SnackBarLayout.Success });
        }
        else
        {
            await SnackBarService!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                await didChange.Content.ReadAsStringAsync(),
                BadRequestTimeSpan
            ) { SnackBarLayout = SnackBar.SnackBarLayout.Error });
        }
    }

    async Task EquipTeamAsync()
    {
        var res = await Http.PostAsync("TeamPage/equip-team",
            new FormUrlEncodedContent([
                new KeyValuePair<string, string>
                    ("teamId", CurrentTeam!.Id.ToString())
            ]));
        if (res.IsSuccessStatusCode)
        {
            TeamCharacterDto!.EquippedTeamId = CurrentTeam.Id;
            StateHasChanged();
            await SnackBarService!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                $"Team {CurrentTeam.Name} is now equipped!",
                BadRequestTimeSpan
            ) { SnackBarLayout = SnackBar.SnackBarLayout.Success });
        }
        else
        {
            await SnackBarService!.DisplaySnackBarAsync(new SnackBar.SnackBarParams(
                await res.Content.ReadAsStringAsync(),
                BadRequestTimeSpan
            ) { SnackBarLayout = SnackBar.SnackBarLayout.Error });
        }
    }


}

<Navigation>
    @if (TeamCharacterDto is not null && CurrentTeam is not null)
    {
        <div class="za-parent">
            <div class="team-settler">
                <div class="inputs">
                    <select @onchange="OnChangeTeamAsync">
                        @foreach (var i in TeamCharacterDto.Teams)
                        {
                            <option selected="@(i == CurrentTeam)" value="@i.Id">@i.Name</option>
                        }
                    </select>
                    <input type="text" placeholder="rename" @onchange="RenameTeamAsync"/>
                    @{
                        var currentIsEquipped = CurrentTeam == TeamCharacterDto.EquippedTeam;
                    }
                    <button style="@(currentIsEquipped ? "background-color: grey" : "")"
                            @onclick="EquipTeamAsync" class="equip-button">
                        @(currentIsEquipped ? "Equipped" : "Equip")
                    </button>
                </div>

                @{
                    var borderCol = WebsiteTheme == WebsiteTheme.Dark ? "white" : "black";
                }
                @code{

                    public CharacterDto? PendingCharacter { get; set; }

                }
                <div class="team-characters-container">
                    @for (var i = 1; i <= 4; i++)
                    {
                        var character = CurrentTeam.GetCharacter(i, TeamCharacterDto);

                        var characterBor = PendingCharacter is not null && 
                                           PendingCharacter == character ? TheBorderToUse : borderCol;
                        var i1 = i;
                        <div class="team-character-div" style="border-color: @characterBor; background-color: @(WebsiteTheme == WebsiteTheme.Dark ? "gray" : "lightgrey")">
                            <a style="border-color:  inherit" href="/inventory/characters/@(character?.Number ?? 0)">
                                <img style="border-color: inherit" src="@character?.ImageUrl" alt=""/>
                            </a>
                            <div class="paragraphs">
                                <p>@(character?.Name ?? "EMPTY SLOT")</p>
                                @if (character is not null)
                                {
                                    <p class="minor-info">Num @character.Number</p>
                                    <p class="minor-info">@(string.Concat(Enumerable.Repeat("\u2b50", character.RarityNum)))</p>
                                    <p class="minor-info">Lvl @character.Level</p>
                                }
                            </div>
                            @code{

                                async Task SlotButtonStuffAsync(CharacterDto? characterDto, int slot)
                                {
                                    if (PendingCharacter is null && characterDto is not null)
                                    {
                                        PendingCharacter = characterDto;
                                    }
                                    else if (PendingCharacter == characterDto && characterDto is not null)
                                    {
                                        await RemoveFromTeamAsync(slot);
                                        PendingCharacter = null;
                                    } else if (PendingCharacter is not null)
                                    {
                                        await PutCharacterInSlot(slot, PendingCharacter);
                                        PendingCharacter = null;
                                    }
                                }
    
                            }
                            @{
                            var teamCount = CurrentTeam.CharacterSlots.Count;
                        }
                            @if ((PendingCharacter is null && character is not null)
                             || (PendingCharacter is not null && PendingCharacter != character)
                        || (PendingCharacter is not null && teamCount > 1))
                            {
                                <div class="delete-bin-div" @onclick="() => SlotButtonStuffAsync(character, i1)">
                                    <span class="material-symbols-outlined">
                                        @if (PendingCharacter is null && character is not null)
                                        {
                                            @("touch_app")
                                        }
                                        else if (PendingCharacter == character && character is not null)
                                        {
                                            @("close")
                                        } else if (TeamCharacterDto.EquippedTeam.GetCharacters(TeamCharacterDto).Contains(PendingCharacter)
                                                   && character is not null)
                                        {
                                            @("swap_horiz")
                                        }
                                        else if (PendingCharacter is not null && character is not null)
                                        {
                                            @("swap_horiz")
                                        } else if (PendingCharacter is not null)
                                        {
                                            @("add")
                                        }
                                    </span>
                                </div>
                            }
       
                        


                        </div>
                    }
                </div>

            </div>
            @{
                var borCol = WebsiteTheme == WebsiteTheme.Dark ? "gray" : "black";
            }
            <div class="others-parent" style="border-color: @borCol">
                <div class="others">


                    <div class="filters">
                        <div class="filter-class">
                            <span class="material-symbols-outlined">
                                search
                            </span>
                            <input @onchange="args => _currentFilter = (string)args.Value!" style="border-color: @(WebsiteTheme == WebsiteTheme.Dark ? "white" : "black")" type="text" placeholder="Search"/>

                        </div>
                        <select @bind="CurrentSortType" style="width: 75px; height: 30px">
                            @foreach (var i in Enum.GetValues<SortType>())
                            {
                                <option value="@i">@i</option>
                            }
                        </select>
                        <input @bind="reverseOrder" type="checkbox"/>
                    </div>


                    @code{

                        Task RemoveFromTeam(CharacterDto characterToRemove)
                        {
                            if (characterToRemove is null) return Task.CompletedTask;
                            var currentSlot = CurrentTeam!.CharacterSlots.FirstOrDefault(i => i.CharacterId == characterToRemove.Id);
                            if (currentSlot is not null)
                            {
                                return RemoveFromTeamAsync(currentSlot.Slot);
                            }

                            return Task.CompletedTask;
                        }

                    }

                    <div class="other-characters-parent" style="border-color: @borCol">
                        <div class="other-characters">

                            @code{

                                public IEnumerable<CharacterDto> NonTeamedCharacters
                                {
                                    get
                                    {
                                        var gotten = TeamCharacterDto?.Characters
                                            .Except(CurrentTeam?.GetCharacters(TeamCharacterDto) ?? [])
                                            .Where(i =>
                                                i.Name!.Contains(_currentFilter, StringComparison.CurrentCultureIgnoreCase)) ?? [];
                                        switch (CurrentSortType)
                                        {
                                            case SortType.Level:
                                                gotten = gotten.OrderByDescending(i => i.Level);
                                                break;
                                            case SortType.Rarity:
                                                gotten = gotten.OrderByDescending(i => i.RarityNum);
                                                break;
                                            case SortType.Name:
                                                gotten = gotten.OrderBy(i => i.Name);
                                                break;
                                        }

                                        if (reverseOrder)
                                            gotten = gotten.Reverse();
                                        return gotten;
                                    }
                                }

                            }

                            @{
                                foreach (var i in NonTeamedCharacters)

                                {
                                    <div class="character-div">
                                        <a  style="border-color: @(WebsiteTheme == WebsiteTheme.Dark ? "white" : "black")" href="/inventory/characters/@i.Number">
                                            <img src="@i.ImageUrl" style="border-color: @(PendingCharacter== i ? TheBorderToUse : "inherit");
                                                border-width: @(PendingCharacter == i ? "3px": "2px")" alt=""/>
                                        </a>
                                        <p>@i.Name</p>
                                        <p class="stars">@(string.Concat(Enumerable.Repeat("\u2b50", i.RarityNum)))</p>
                                        <p>Num @i.Number</p>
                                        <p>Lvl @i.Level</p>
                                        <button style="@(PendingCharacter == i ? "background-color: gray" : "")" class="char-button" @onclick="() => PendingCharacter = i">Add</button>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="loading-or-failure-div">
            <div>
                @if (ErrorText is null)
                {
                    <h1>Loading...</h1>
                }
                else
                {
                    <h1>@ErrorText</h1>
                }
            </div>
        </div>
    }
</Navigation>